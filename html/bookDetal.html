<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/list-to-detail.css" />
		<script src="../js/vue.min.js" type="text/javascript" charset="utf-8"></script>
		<style type="text/css">
			*{
				margin: 0;
				padding: 0;
				background-color: #FFFFFF;
			}
			
			.font-color-gray {
				color: #6D6D72;
				font-size: 16px;
				font-weight: 800
			}
			
			.font-color-black {
				font-size: 16px;
				font-weight: 800;
				color: black;
			}
			
			.mui-btn {
				background-color: #FFEADA;
				border-color: #DFC8B6;
			}
						
			#banner {
				margin-top: 40px;
				width: 100%;
				height: 73px;
				/*height:30% ;*/
				background-image: url(../images/book/banner4.png);
				background-size: cover;
			}
			
			#book {
				height: 230px;
				/*border-style: solid;*/
				padding-top: 20px;
			}
			
			#book-name {
				border-color: deepskyblue;
				border-width: 5px;
				padding-left: 3px;
				border-left-style: solid;
				margin-left: 18px;
				font-size: 22px;
				font-weight: 700;
			}
			
			#book-img {
				width: 43%;
				height: 200px;
				/*border-style: solid;*/
				float: left;
				position: relative;
			}
			
			#book-img img {
				position: absolute;
				top: 20px;
				left: 19px;
				width: 120px;
			}
			
			#bookdetail {
				margin-top: 24px;
				width: 57%;
				height: 160px;
				/*border-style: solid;*/
				float: right;
				border-left-style: solid;
				border-color: #C8C7CC;
				border-width: 1px;
				position: relative;
				padding-left: 5px;
			}
			
			#detail-ul {
				/*border-style: solid;*/
				height: 200px;
				position: absolute;
				top: -5px;
				/*position: relative;*/
			}
			
			#detail-ul li{
				list-style: none;
				margin-top: 7px;
			}
			
			.star li {
				float: left;
			}
			
			.star img {
				width: 20px;
				height: 20px;
			}
			
			#book-comment-top {
				position: relative;
				/*border-style: solid;*/
				height: 50px;
			}
			
			#book-comment {
				padding-top: 30px;
				/*border-style: solid;*/
				height: 160px;
			}
			
			#book-comment li{
				float: left;
				list-style: none;
				/*margin-left: 10px;*/
			}
			
			#button-list {
				width: 60%;
			}
			
			#myStars {
				margin-left: 43px;
				margin-top: -29px;
			}
			
			#comment-star {
				position: relative;
				width: 50%;
				float: left;
				top: -6px;
				/*border-style: solid;*/
				/*border-color: red;*/
			}
			#comment-star li {
				padding-top: 6px;
			}
			
			#button-list li{
				margin-left: 18px;
			}
			
			#comment-star-li {
				position: absolute;
				top: 8px;
				left: 15px;
			}
			
			#book-comment-center li{
				margin-left: 25px;
				margin-top: 15px;
				
			}
			
			#book-comment-center img{
				height: 15px;
				width: 15px;
				src: url(../images/book/star.png);				
			}
			
			#commentInput {
				display: none;
			}
			
			.bottom5{
				margin-bottom:5px ;
			}
			
			.bottomBtn{
				font-size: 20px;
				position: relative;
				top: 5px;
			}
			
			.editInput{
				padding: 8px 15px;
				line-height: 1.2;
				margin: 0 0 10px 15px;
				font-size: 14px;
				width: 72%;
			}	
			
		</style>
	</head>
	<body>
		<div class="mui-content">
			<div id="banner"></div>
			<div id="book">
				<div id="book-name">
					{{book_name}}
				</div>
				<div id="book-img">
					<span id="img" v-html='book_image'>{{book_image}}</span>
				</div>
				<div id="bookdetail">
					<ul id="detail-ul">
						<li><span class="font-color-gray">分类:</span><span class="font-color-black">{{book_type}}</span></li>
						<li><span class="font-color-gray">借书日期:</span><span class="font-color-black">{{book_out_time}}</span></li>
						<li><span class="font-color-gray">还书日期:</span><span class="font-color-black">{{book_int_time}}</span></li>
						<li><span class="font-color-gray">状态:</span><span id="state">{{book_state}}</span></li>	
						<li><span class="font-color-gray">综合评价:</span>
							<ul class="star">
								<li v-for="n in book_star"><img src="../images/book/star.png" /></li>
								<li v-for="n in book_star_half"><img src="../images/book/starHalf.png" /></li>
							</ul>
						</li>
					</ul>
				</div>
			</div>
			<div id="book-comment">
				<div id="book-comment-top">
					<div id="button-list">
						<ul>
							<li><button id="renew-button" type="button" class="mui-btn">续借</button></li>
							<li><button id="comment-button" type="button" class="mui-btn">评价</button></li>
							<!--<li><button type="button" class="mui-btn">收藏</button></li>-->
							
						</ul>
					</div>
					<div id="comment-star">
						<li id="comment-star-li"><span>评分:</span>
								<ul class="star" id="myStars">
									<li><img id="star0" src="../images/book/star2.png" /></li>
									<li><img id="star1" src="../images/book/star2.png" /></li>
									<li><img id="star2" src="../images/book/star2.png" /></li>
									<li><img id="star3" src="../images/book/star2.png" /></li>
									<li><img id="star4" src="../images/book/star2.png" /></li>
								</ul>
						</li>
					</div>
					
				</div>
				<div id="book-comment-center">
					<ul>
						<li><img src="../images/book/pen.png"/><a>写笔记</a></li>
						<li><img src="../images/book/pen.png"/><a id="xieShuPing">写书评</a></li>
						<li><a>分享</a></li>
					</ul>
				</div>
				<div class="editComment bottom5 bg_ededed" id="commentInput">
					<textarea class="editInput" id="edit" name="" rows="1" cols="" placeholder="你的书评"></textarea>
					<button type="button" class="commentBtn" id="submit">提交</button>
					<span id="oneComment"></span>
				</div>
			</div>
				<div class="mui-card" v-for="item in items">
					<div class="mui-card-header mui-card-media">
						<img src="../images/mySetting/head Portrait.png" />
						<div class="mui-media-body">
							{{item.comment_author}}
							<p>发表于 2018-08-30 15:30</p>
							<div class="mui-card-content" >
							{{item.comment_content}}
							</div>
						</div>
					</div>
					<div class="mui-card-footer">
						<a class="mui-card-link">点赞</a>
						<!--<a class="mui-card-link">Comment</a>-->
						<a class="mui-card-link">评论</a>
					</div>
				</div>	
				<div v-for="n in isNoComment">
					<div class="mui-card-header mui-card-media">
						<div class="mui-media-body">
							<div class="mui-card-content" >
							<p>暂时没有书评</p>
							</div>
						</div>
					</div>
				</div>	
		</div>
		
	</div>
		
		
		<script src="../js/mui.min.js"></script>
		<script type="text/javascript">
			mui.init();
			
			function getDefaultData() {
				return {
					book_image: '',
					book_int_time: '',
					book_name: '',
					book_out_time: '',
					book_state: '',
					book_type: '',
					book_uid: '',
					book_star:'',
					book_star_half:'',
					isNoComment: 0,
					items:[]
				}
			}
			
			var bookDetal = new Vue({
				el: '.mui-content',
				data: getDefaultData(),
			});
			
			//监听自定义事件，获取图书详情
			document.addEventListener('get_detail', function(event) {	
				//前页传入的数据，直接渲染，无需等待ajax请求详情后
				bookDetal.book_image = event.detail.book_image;
				bookDetal.book_int_time = dateChange(event.detail.book_int_time);
				bookDetal.book_name = event.detail.book_name;
				bookDetal.book_out_time = dateChange(event.detail.book_out_time);
				bookDetal.book_state = ifBack(event.detail.book_state);
				bookDetal.book_type = event.detail.book_type;
				bookDetal.book_uid = event.detail.book_uid;
				//向服务端请求书本综合评分和评论
				commentAjax();
			});
			
			//窗口隐藏时，重置页面数据
			mui.plusReady(function () {
				var self = plus.webview.currentWebview();
				self.addEventListener("hide",function (e) {
					window.scrollTo(0, 0);
					bookDetal.book_image='';
					bookDetal.book_int_time='';
					bookDetal.book_name='';
					bookDetal.book_out_time='';
					bookDetal.book_state='';
					bookDetal.book_type='';
					bookDetal.book_uid='';
					bookDetal.items.length='';
					bookDetal.isNoComment='';
					for(var i=0;i<oStar.length;i++){
						oStar[i].src = '../images/book/star2.png';//评分星星清空
					}
					bookDetal.book_star_half=0;//综合评价星星清空
					bookDetal.book_star = 0;//综合评价星星清空
					localStorage.setItem("myStars", -1); //评价初始化为-1
					document.getElementById('commentInput').style.display='none';
				},false);
			})
			
			//重写返回逻辑
			mui.back = function() {
				plus.webview.currentWebview().hide("fade-out", 300);
			}
			
			//续借按钮事件
			document.getElementById('renew-button').addEventListener('tap',function(){
				if(bookDetal.book_state=='已归还'){
					mui.toast('该书已归还，无法续借');
				}
				else{
					var array = new Array('确定','取消');
					mui.confirm('我还没看完,还书日期延后3个月',array, function(e) {
	                    if (e.index == 0) {
	                    	mui.ajax(localStorage.getItem("url")+'/demo/book_renewal',{
								data:{
									stu_account:localStorage.getItem("TOKEN_USER"),
									book_name:bookDetal.book_name
								},
								dataType:'json',//服务器返回json格式数据
								type:'post',//HTTP请求类型
								timeout:10000,//超时时间设置为10秒；	              
								success:function(data){//服务器返回响应，根据响应结果
									if(data.success){
										mui.toast('续借成功');
									}
									else{
										mui.alert('续借失败!');
									}										
								},
								error:function(xhr,type,errorThrown){
									//异常处理；
									mui.alert(type);
								}
							});
	                    } else {
	                       
	                    }
	                })
				}
				
			});
	
			//星星评价事件
			var oStar=new Array();
			var oStar = document.getElementById('comment-star-li').getElementsByTagName('img');
			for(var i=0;i<oStar.length;i++){
				oStar[i].addEventListener('tap',function(){
					for(var i=0;i<oStar.length;i++){
						oStar[i].src = '../images/book/star2.png';
					}
					lightStar(this,oStar);
				})
			}
			
			//点亮星星函数 
			localStorage.setItem("myStars", -1); 
			function lightStar(obj,oStar){
				var str = obj.getAttribute('id');
				var number =str.charAt(str.length-1);
				if(localStorage.getItem("myStar")!=-1){
					localStorage.setItem("myStars", parseInt(number)+1);
				}
				else{
					localStorage.setItem("myStars", 0);
				}
				while(number!=-1){
					oStar[number].src='../images/book/star.png';
					number--;
				}
			}
			
			//确定评价按钮事件
			document.getElementById('comment-button').addEventListener('tap',function(){
				var array = new Array('确定','取消');
				if(localStorage.getItem("myStars")==-1){
					localStorage.setItem("myStars", 0);
				}
				mui.confirm('将本书评价为'+localStorage.getItem("myStars")+'星?','我的评价' ,array, function(e) {
                    if (e.index == 0) {
                    	mui.ajax(localStorage.getItem("url")+'/demo/giveBookStar?studentNumber='+localStorage.getItem("TOKEN_USER")+'&book_name='+bookDetal.book_name+'&stu_score='+localStorage.getItem("myStars"),{
							dataType:'json',//服务器返回json格式数据
							type:'get',//HTTP请求类型
							timeout:10000,//超时时间设置为10秒；
							headers:{'Content-Type':'application/json'},	              
							success:function(data){//服务器返回响应，根据响应结果
								mui.toast(data.msg);				
							},
							error:function(xhr,type,errorThrown){
								//异常处理；
								console.log(type);
							}
						});
                       
                    } else {
                       
                    }
                })
			});
			
			//弹出书评输入框事件
			document.getElementById('xieShuPing').addEventListener('tap',function(){
				var oInput = document.getElementById('commentInput');
				oInput.style.display='block';
			});
			
			//提交书评
			document.getElementById("submit").addEventListener('tap',function(){
				var oInput = document.getElementById('commentInput');
				var oEdit = document.getElementById("edit");
				var text = oEdit.value;
				if(!text){
					mui.toast("评论内容不能为空");
					oInput.style.display='none';
				}
				else{
					mui.ajax(localStorage.getItem("url")+'/demo/giveComments/?book_name=' + bookDetal.book_name + '&studentNumber=' + localStorage.getItem("TOKEN_USER") + '&comment=' + text, {
					type:'GET',
					dataType: 'json', //服务器返回json格式数据
					timeout: 15000, //15秒超时
					success: function(data) {
						if(data.state){
							mui.toast("评价成功");
							oInput.style.display='none';
							oEdit.value='';
							commentAjax();
						}
						else{
							oInput.style.display='none';
							oEdit.value='';
							mui.toast("评价失败");
						}
						
//						mui.fire('get_detail');
					},
					error: function(xhr, type, errorThrown) {
						oInput.style.display='none';
						oEdit.value='';
						mui.toast("服务器开小差");
//						mui.toast('评论内容获取失败');
						//TODO 此处可以向服务端告警
					}
				});
				}
			});
			
			//时间格式转换
			function dateChange(time){  
				var date=/\d{4}-\d{1,2}-\d{1,2}/g.exec(time)
			    return date.toLocaleString();
			}
			
			//判断是否归还
			function ifBack(flag){  
				var oState = document.getElementById('state');
				if(flag==0){
					oState.style.color='red';
					return '未归还';
				}
				else {
					oState.style.color='lawngreen';
					return '已归还';
				}
			}
			//读取评论内容
			function getComment(data){
				var items = [];
				var score = data.score.toFixed(1);
				var decimal = score-parseInt(score);
				bookDetal.items.length=0;
				bookDetal.book_star = parseInt(score);
				for(var i=data.comment.length-1;i>=0;i--){//获取评论的内容、头像、时间、账号
					if(data.comment[i].stu_comment){
							var obj = {
	//						comment_headImg: data.comment[i].headImg,
	//						comment_time: data.comment[i].comment_time,
							comment_author: data.comment[i].stu_account,
							comment_content: data.comment[i].stu_comment
						};					
						bookDetal.items.push(obj);						
					}
					else{						
					}					
				}
				if(bookDetal.items.length==0){
					bookDetal.isNoComment=1;
				}
				if(decimal>0){//定义半星数
					bookDetal.book_star_half=1;
				}
				else{
					bookDetal.book_star_half=0;
				}
			}
			//评论ajax请求
			function commentAjax(){
				mui.ajax(localStorage.getItem("url")+'/demo/getBookScoreAndComments/?book_name=' + bookDetal.book_name, {
					type:'GET',
					dataType: 'json', //服务器返回json格式数据
					timeout: 15000, //15秒超时
					success: function(data) {
						getComment(data);
					},
					error: function(xhr, type, errorThrown) {
						bookDetal.isNoComment=1;
//						mui.toast('评论内容获取失败');
						//TODO 此处可以向服务端告警
					}
				});
			}
		</script>
	</body>

</html>